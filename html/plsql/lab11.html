<!doctype html>
<html lang = "en-us">
<head>
    <meta charset = "utf-8">
    <title>Oracle PL/SQL examples by Bill Enkey</title>
    <meta name = "author" content = "Gidgiddoni">
    <meta name = "viewport" content = "width = device-width">
    <link href = "../../css/lab.css" type = "text/css" rel = "stylesheet" media = "screen">
</head>
    <body>
        <header><h1>LAB 11</h1></header>
        <main>
            <h2>Code</h2>
            <p>Triggers are terribly important to a functionally autonomous database. Though several triggers could have been used, I decided to do one in this case. It's a ways down, so you might want to search "CREATE OR REPLACE TRIGGER item_trig".<pre><code>
            /* 
            ** William Enkey
            ** CIT 325, McLaughlin
            ** 2017 FALL
            */ 

            -- Run the clean up and create files -- 
            @/home/student/Data/cit325/oracle/lib/cleanup_oracle.sql
            @/home/student/Data/cit325/oracle/lib/Oracle12cPLSQLCode/Introduction/create_video_store.sql

            SPOOL lab11_2.log

            -- Set some session stuffs
            SET NULL ' '
            SET PAGESIZE 49999

            -- Add a TEXT_FILE_NAME VARCHAR2(30) column
            ALTER TABLE item 
            ADD(text_file_name      VARCHAR2(30));

            -- Verify additional column
            COLUMN table_name   FORMAT A14
            COLUMN column_id    FORMAT 9999
            COLUMN column_name  FORMAT A22
            COLUMN data_type    FORMAT A12
            SELECT   table_name
            ,        column_id
            ,        column_name
            ,        CASE
                       WHEN nullable = 'N' THEN 'NOT NULL'
                       ELSE ''
                     END AS nullable
            ,        CASE
                       WHEN data_type IN ('CHAR','VARCHAR2','NUMBER') THEN
                         data_type||'('||data_length||')'
                       ELSE
                         data_type
                     END AS data_type
            FROM     user_tab_columns
            WHERE    table_name = 'ITEM'
            ORDER BY 2;

            -- Create the logger table --

            CREATE TABLE logger 
            ( LOGGER_ID			          NUMBER        CONSTRAINT pk_logger PRIMARY KEY
            , OLD_ITEM_ID			        NUMBER
            , OLD_ITEM_BARCODE		    VARCHAR2(20)
            , OLD_ITEM_TYPE			      NUMBER
            , OLD_ITEM_TITLE 		      VARCHAR2(60)
            , OLD_ITEM_SUBTITLE		    VARCHAR2(60)
            , OLD_ITEM_RATING		      VARCHAR2(8)
            , OLD_ITEM_RATING_AGENCY 	VARCHAR2(4)
            , OLD_ITEM_RELEASE_DATE		DATE
            , OLD_CREATED_BY 		      NUMBER
            , OLD_CREATION_DATE		    DATE
            , OLD_LAST_UPDATED_BY		  NUMBER
            , OLD_LAST_UPDATE_DATE		DATE
            , OLD_TEXT_FILE_NAME		  VARCHAR2(40)
            , NEW_ITEM_ID			        NUMBER
            , NEW_ITEM_BARCODE		    VARCHAR2(30)
            , NEW_ITEM_TYPE			      NUMBER
            , NEW_ITEM_TITLE 		      VARCHAR2(60)
            , NEW_ITEM_SUBTITLE		    VARCHAR2(60)
            , NEW_ITEM_RATING		      VARCHAR2(8)
            , NEW_ITEM_RATING_AGENCY 	VARCHAR2(4)
            , NEW_ITEM_RELEASE_DATE		DATE
            , NEW_CREATED_BY 		      NUMBER
            , NEW_CREATION_DATE		    DATE
            , NEW_LAST_UPDATED_BY		  NUMBER
            , NEW_LAST_UPDATE_DATE		DATE
            , NEW_TEXT_FILE_NAME		  VARCHAR2(40));

            -- Create the logger sequence --

            CREATE SEQUENCE logger_s START WITH 1001;

            -- Verify table and sequence creation --
            DESC logger;

            -- An insert statement to test that the logger table can work --
            INSERT INTO logger VALUES
            ( logger_s.NEXTVAL
            , 1014, 'barcode', 1050, 'Brave Heart', ' ', 'R', 'MSRP', SYSDATE, 1, SYSDATE, 1, SYSDATE, 'Old Text File Name'
            , 1014, 'BARCODE', 1050, 'Brave Heart', ' ', 'R', 'MSRP', SYSDATE, 1, SYSDATE, 1, SYSDATE, 'New Text File Nam');

            -- Verify --
            /* Query the logger table. */
            COL logger_id       FORMAT 9999 HEADING "Logger|ID #"
            COL old_item_id     FORMAT 9999 HEADING "Old|Item|ID #"
            COL old_item_title  FORMAT A20  HEADING "Old Item Title"
            COL new_item_id     FORMAT 9999 HEADING "New|Item|ID #"
            COL new_item_title  FORMAT A30  HEADING "New Item Title"
            SELECT l.logger_id
            ,      l.old_item_id
            ,      l.old_item_title
            ,      l.new_item_id
            ,      l.new_item_title
            FROM   logger l;

            -- Create MANAGE_ITEM package with overloaded INSERT_ITEM autonomous procedures --

            CREATE OR REPLACE PACKAGE manage_item IS
              PROCEDURE item_insert
                ( PV_NEW_ITEM_ID 		        NUMBER
                , PV_NEW_ITEM_BARCODE		    VARCHAR2
                , PV_NEW_ITEM_TYPE		      NUMBER
                , PV_NEW_ITEM_TITLE		      VARCHAR2
                , PV_NEW_ITEM_SUBTITLE		  VARCHAR2
                , PV_NEW_ITEM_RATING		    VARCHAR2
                , PV_NEW_ITEM_RATING_AGENCY	VARCHAR2
                , PV_NEW_ITEM_RELEASE_DATE	DATE
                , PV_NEW_CREATED_BY		      NUMBER
                , PV_NEW_CREATION_DATE		  DATE
                , PV_NEW_LAST_UPDATED_BY 	  NUMBER
                , PV_NEW_LAST_UPDATE_DATE	  DATE
                , PV_NEW_TEXT_FILE_NAME		  VARCHAR2);

              PROCEDURE item_insert
                ( PV_OLD_ITEM_ID 		        NUMBER
                , PV_OLD_ITEM_BARCODE		    VARCHAR2
                , PV_OLD_ITEM_TYPE		      NUMBER
                , PV_OLD_ITEM_TITLE		      VARCHAR2
                , PV_OLD_ITEM_SUBTITLE		  VARCHAR2
                , PV_OLD_ITEM_RATING		    VARCHAR2
                , PV_OLD_ITEM_RATING_AGENCY	VARCHAR2
                , PV_OLD_ITEM_RELEASE_DATE	DATE
                , PV_OLD_CREATED_BY		      NUMBER
                , PV_OLD_CREATION_DATE		  DATE
                , PV_OLD_LAST_UPDATED_BY 	  NUMBER
                , PV_OLD_LAST_UPDATE_DATE	  DATE
                , PV_OLD_TEXT_FILE_NAME		  VARCHAR2
                , PV_NEW_ITEM_ID 		        NUMBER
                , PV_NEW_ITEM_BARCODE		    VARCHAR2
                , PV_NEW_ITEM_TYPE		      NUMBER
                , PV_NEW_ITEM_TITLE		      VARCHAR2
                , PV_NEW_ITEM_SUBTITLE		  VARCHAR2
                , PV_NEW_ITEM_RATING		    VARCHAR2
                , PV_NEW_ITEM_RATING_AGENCY	VARCHAR2
                , PV_NEW_ITEM_RELEASE_DATE	DATE
                , PV_NEW_CREATED_BY		      NUMBER
                , PV_NEW_CREATION_DATE		  DATE
                , PV_NEW_LAST_UPDATED_BY 	  NUMBER
                , PV_NEW_LAST_UPDATE_DATE	  DATE
                , PV_NEW_TEXT_FILE_NAME		  VARCHAR2);

              PROCEDURE item_insert
                ( PV_OLD_ITEM_ID 		        NUMBER
                , PV_OLD_ITEM_BARCODE		    VARCHAR2
                , PV_OLD_ITEM_TYPE		      NUMBER
                , PV_OLD_ITEM_TITLE		      VARCHAR2
                , PV_OLD_ITEM_SUBTITLE		  VARCHAR2
                , PV_OLD_ITEM_RATING		    VARCHAR2
                , PV_OLD_ITEM_RATING_AGENCY	VARCHAR2
                , PV_OLD_ITEM_RELEASE_DATE	DATE
                , PV_OLD_CREATED_BY		      NUMBER
                , PV_OLD_CREATION_DATE		  DATE
                , PV_OLD_LAST_UPDATED_BY 	  NUMBER
                , PV_OLD_LAST_UPDATE_DATE	  DATE
                , PV_OLD_TEXT_FILE_NAME		  VARCHAR2);

            END;
            /

            -- Verify package creation --
            DESC manage_item;

            -- Create the package body --
            CREATE OR REPLACE PACKAGE BODY manage_item IS

                -- INSERT procedure --
                PROCEDURE item_insert
                ( PV_NEW_ITEM_ID 		        NUMBER
                , PV_NEW_ITEM_BARCODE		    VARCHAR2
                , PV_NEW_ITEM_TYPE		      NUMBER
                , PV_NEW_ITEM_TITLE		      VARCHAR2
                , PV_NEW_ITEM_SUBTITLE		  VARCHAR2
                , PV_NEW_ITEM_RATING		    VARCHAR2
                , PV_NEW_ITEM_RATING_AGENCY	VARCHAR2
                , PV_NEW_ITEM_RELEASE_DATE	DATE
                , PV_NEW_CREATED_BY		      NUMBER
                , PV_NEW_CREATION_DATE		  DATE
                , PV_NEW_LAST_UPDATED_BY 	  NUMBER
                , PV_NEW_LAST_UPDATE_DATE	  DATE
                , PV_NEW_TEXT_FILE_NAME		  VARCHAR2) IS

              PRAGMA AUTONOMOUS_TRANSACTION;

                -- variable for the sequence --
                lv_logger_s		NUMBER 	:= logger_s.NEXTVAL;

                BEGIN

                    SAVEPOINT before_insert;

                    INSERT INTO logger VALUES( lv_logger_s
                                          , NULL
                                          , NULL
                                          , NULL
                                          , NULL
                                          , NULL
                                          , NULL
                                                            , NULL
                                                            , NULL
                                                            , NULL
                                                            , NULL
                                                            , NULL
                                                            , NULL
                                                            , NULL
                                                            , PV_NEW_ITEM_ID
                                                            , PV_NEW_ITEM_BARCODE
                                                            , PV_NEW_ITEM_TYPE
                                                            , PV_NEW_ITEM_TITLE
                                                            , PV_NEW_ITEM_SUBTITLE
                                                            , PV_NEW_ITEM_RATING
                                                            , PV_NEW_ITEM_RATING_AGENCY
                                                            , PV_NEW_ITEM_RELEASE_DATE
                                                            , PV_NEW_CREATED_BY
                                                            , PV_NEW_CREATION_DATE
                                                            , PV_NEW_LAST_UPDATED_BY
                                                            , PV_NEW_LAST_UPDATE_DATE
                                                            , PV_NEW_TEXT_FILE_NAME);

                -- When successful --
                COMMIT;

                -- In case of error --
                EXCEPTION
                    WHEN OTHERS THEN ROLLBACK TO before_insert;
                RETURN;

                END;  -- INSERT procedure --

                -- UPDATE procedure --
              PROCEDURE item_insert
                ( PV_OLD_ITEM_ID 		        NUMBER
                , PV_OLD_ITEM_BARCODE		    VARCHAR2
                , PV_OLD_ITEM_TYPE		      NUMBER
                , PV_OLD_ITEM_TITLE		      VARCHAR2
                , PV_OLD_ITEM_SUBTITLE		  VARCHAR2
                , PV_OLD_ITEM_RATING		    VARCHAR2
                , PV_OLD_ITEM_RATING_AGENCY	VARCHAR2
                , PV_OLD_ITEM_RELEASE_DATE	DATE
                , PV_OLD_CREATED_BY		      NUMBER
                , PV_OLD_CREATION_DATE		  DATE
                , PV_OLD_LAST_UPDATED_BY 	  NUMBER
                , PV_OLD_LAST_UPDATE_DATE	  DATE
                , PV_OLD_TEXT_FILE_NAME		  VARCHAR2
                , PV_NEW_ITEM_ID 		        NUMBER
                , PV_NEW_ITEM_BARCODE		    VARCHAR2
                , PV_NEW_ITEM_TYPE		      NUMBER
                , PV_NEW_ITEM_TITLE		      VARCHAR2
                , PV_NEW_ITEM_SUBTITLE		  VARCHAR2
                , PV_NEW_ITEM_RATING		    VARCHAR2
                , PV_NEW_ITEM_RATING_AGENCY	VARCHAR2
                , PV_NEW_ITEM_RELEASE_DATE	DATE
                , PV_NEW_CREATED_BY		      NUMBER
                , PV_NEW_CREATION_DATE		  DATE
                , PV_NEW_LAST_UPDATED_BY 	  NUMBER
                , PV_NEW_LAST_UPDATE_DATE	  DATE
                , PV_NEW_TEXT_FILE_NAME     VARCHAR2) IS

                PRAGMA AUTONOMOUS_TRANSACTION;

                -- A variable for the sequence --    
                lv_logger_s   NUMBER  := logger_s.NEXTVAL;

                BEGIN

                SAVEPOINT before_insert;

                INSERT INTO logger VALUES ( lv_logger_s
                                          , PV_OLD_ITEM_ID
                                          , PV_OLD_ITEM_BARCODE
                                          , PV_OLD_ITEM_TYPE
                                          , PV_OLD_ITEM_TITLE
                                          , PV_OLD_ITEM_SUBTITLE
                                          , PV_OLD_ITEM_RATING
                                                            , PV_OLD_ITEM_RATING_AGENCY
                                                            , PV_OLD_ITEM_RELEASE_DATE
                                                            , PV_OLD_CREATED_BY
                                                            , PV_OLD_CREATION_DATE
                                                            , PV_OLD_LAST_UPDATED_BY
                                                            , PV_OLD_LAST_UPDATE_DATE
                                                            , PV_OLD_TEXT_FILE_NAME
                                                            , PV_NEW_ITEM_ID
                                                            , PV_NEW_ITEM_BARCODE
                                                            , PV_NEW_ITEM_TYPE
                                                            , PV_NEW_ITEM_TITLE
                                                            , PV_NEW_ITEM_SUBTITLE
                                                            , PV_NEW_ITEM_RATING
                                                            , PV_NEW_ITEM_RATING_AGENCY
                                                            , PV_NEW_ITEM_RELEASE_DATE
                                                            , PV_NEW_CREATED_BY
                                                            , PV_NEW_CREATION_DATE
                                                            , PV_NEW_LAST_UPDATED_BY
                                                            , PV_NEW_LAST_UPDATE_DATE
                                                            , PV_NEW_TEXT_FILE_NAME);

                -- If no error --
                COMMIT;

                -- In case of error --
                EXCEPTION 
                    WHEN OTHERS THEN ROLLBACK TO before_insert;
                RETURN;

                END; -- UDPATE procedure --

              -- DELETE procedure --
                PROCEDURE item_insert
                ( PV_OLD_ITEM_ID 		        NUMBER
                , PV_OLD_ITEM_BARCODE		    VARCHAR2
                , PV_OLD_ITEM_TYPE		      NUMBER
                , PV_OLD_ITEM_TITLE		      VARCHAR2
                , PV_OLD_ITEM_SUBTITLE		  VARCHAR2
                , PV_OLD_ITEM_RATING		    VARCHAR2
                , PV_OLD_ITEM_RATING_AGENCY	VARCHAR2
                , PV_OLD_ITEM_RELEASE_DATE	DATE
                , PV_OLD_CREATED_BY		      NUMBER
                , PV_OLD_CREATION_DATE		  DATE
                , PV_OLD_LAST_UPDATED_BY 	  NUMBER
                , PV_OLD_LAST_UPDATE_DATE	  DATE
                , PV_OLD_TEXT_FILE_NAME		  VARCHAR2) IS

              PRAGMA AUTONOMOUS_TRANSACTION;

                -- variable for the sequence --
                lv_logger_s		NUMBER 	:= logger_s.NEXTVAL;

                BEGIN

                    SAVEPOINT before_insert;

                    INSERT INTO logger VALUES( lv_logger_s
                                          , PV_OLD_ITEM_ID
                                          , PV_OLD_ITEM_BARCODE
                                          , PV_OLD_ITEM_TYPE
                                          , PV_OLD_ITEM_TITLE
                                          , PV_OLD_ITEM_SUBTITLE
                                          , PV_OLD_ITEM_RATING
                                                            , PV_OLD_ITEM_RATING_AGENCY
                                                            , PV_OLD_ITEM_RELEASE_DATE
                                                            , PV_OLD_CREATED_BY
                                                            , PV_OLD_CREATION_DATE
                                                            , PV_OLD_LAST_UPDATED_BY
                                                            , PV_OLD_LAST_UPDATE_DATE
                                                            , PV_OLD_TEXT_FILE_NAME
                                                            , NULL
                                                            , NULL
                                                            , NULL
                                                            , NULL
                                                            , NULL
                                                            , NULL
                                                            , NULL
                                                            , NULL
                                                            , NULL
                                                            , NULL
                                                            , NULL
                                                            , NULL
                                                            , NULL);

                -- When successful --
                COMMIT;

                -- In case of error --
                EXCEPTION
                    WHEN OTHERS THEN ROLLBACK TO before_insert;
                RETURN;

                END; -- DELETE procedure --

            END manage_item;
            /

            /* "You only write one INSERT statement to the logger table, and you put it in the most complete (or largest parameter list version) of the item_insert procedure. The other versions of the overloaded procedure become wrappers that add null values to the missing parameter items and call the most complete version of the overloaded procedure. Taking this approach ultimately lowers maintenance coding costs." Michael McLaughlin */

            -- TEST CASE for STEP 02 --

            DECLARE
              CURSOR get_row IS
                SELECT * FROM item WHERE item_title = 'King Arthur';

            BEGIN
              FOR i IN get_row LOOP
                manage_item.item_insert( PV_NEW_ITEM_ID            => i.item_id
                              , PV_NEW_ITEM_BARCODE       => i.item_barcode
                              , PV_NEW_ITEM_TYPE          => i.item_type
                              , PV_NEW_ITEM_TITLE         => i.item_title         || '-Inserted'
                              , PV_NEW_ITEM_SUBTITLE      => i.item_subtitle
                              , PV_NEW_ITEM_RATING        => i.item_rating
                              , PV_NEW_ITEM_RATING_AGENCY => i.item_rating_agency
                              , PV_NEW_ITEM_RELEASE_DATE  => i.item_release_date
                              , PV_NEW_CREATED_BY         => i.created_by
                              , PV_NEW_CREATION_DATE      => i.creation_date
                              , PV_NEW_LAST_UPDATED_BY    => i.last_updated_by
                              , PV_NEW_LAST_UPDATE_DATE   => i.last_update_date
                              , PV_NEW_TEXT_FILE_NAME     => i.text_file_name     || '-Inserted');
              END LOOP;
            END;
            /

            DECLARE
            /* Dynamic cursor. */
              CURSOR get_row IS
                SELECT * FROM item WHERE item_title = 'King Arthur';

            BEGIN
            /* Read the dynamic cursor. */
              FOR i IN get_row LOOP
                manage_item.item_insert( PV_OLD_ITEM_ID => i.item_id          
                          , PV_OLD_ITEM_BARCODE       => i.item_barcode
                          , PV_OLD_ITEM_TYPE          => i.item_type
                          , PV_OLD_ITEM_TITLE         => i.item_title
                          , PV_OLD_ITEM_SUBTITLE      => i.item_subtitle
                          , PV_OLD_ITEM_RATING        => i.item_rating
                              , PV_OLD_ITEM_RATING_AGENCY => i.item_rating_agency
                              , PV_OLD_ITEM_RELEASE_DATE  => i.item_release_date
                              , PV_OLD_CREATED_BY         => i.created_by
                              , PV_OLD_CREATION_DATE      => i.creation_date
                              , PV_OLD_LAST_UPDATED_BY    => i.last_updated_by
                              , PV_OLD_LAST_UPDATE_DATE   => i.last_update_date
                              , PV_OLD_TEXT_FILE_NAME     => i.text_file_name
                              , PV_NEW_ITEM_ID            => i.item_id
                              , PV_NEW_ITEM_BARCODE       => i.item_barcode 
                              , PV_NEW_ITEM_TYPE          => i.item_type
                              , PV_NEW_ITEM_TITLE         => i.item_title         || '-Changed'
                              , PV_NEW_ITEM_SUBTITLE      => i.item_subtitle
                              , PV_NEW_ITEM_RATING        => i.item_rating
                              , PV_NEW_ITEM_RATING_AGENCY => i.item_rating_agency
                              , PV_NEW_ITEM_RELEASE_DATE  => i.item_release_date
                              , PV_NEW_CREATED_BY         => i.created_by
                              , PV_NEW_CREATION_DATE      => i.creation_date
                              , PV_NEW_LAST_UPDATED_BY    => i.last_updated_by
                              , PV_NEW_LAST_UPDATE_DATE   => i.last_update_date
                              , PV_NEW_TEXT_FILE_NAME     => i.text_file_name     || '-Changed');
              END LOOP;
            END;
            /

            DECLARE
              CURSOR get_row IS
                SELECT * FROM item WHERE item_title = 'King Arthur';
            BEGIN
              FOR i IN get_row LOOP
                manage_item.item_insert( PV_OLD_ITEM_ID            => i.item_id
                              , PV_OLD_ITEM_BARCODE       => i.item_barcode
                              , PV_OLD_ITEM_TYPE          => i.item_type
                              , PV_OLD_ITEM_TITLE         => i.item_title         || '-Deleted'
                              , PV_OLD_ITEM_SUBTITLE      => i.item_subtitle
                              , PV_OLD_ITEM_RATING        => i.item_rating
                              , PV_OLD_ITEM_RATING_AGENCY => i.item_rating_agency
                              , PV_OLD_ITEM_RELEASE_DATE  => i.item_release_date
                              , PV_OLD_CREATED_BY         => i.created_by
                              , PV_OLD_CREATION_DATE      => i.creation_date
                              , PV_OLD_LAST_UPDATED_BY    => i.last_updated_by
                              , PV_OLD_LAST_UPDATE_DATE   => i.last_update_date
                              , PV_OLD_TEXT_FILE_NAME     => i.text_file_name     || '-Deleted');
              END LOOP;
            END;
            /

            -- Query the test case ie the logger table--
            COL logger_id       FORMAT 9999 HEADING "Logger|ID #"
            COL old_item_id     FORMAT 9999 HEADING "Old|Item|ID #"
            COL old_item_title  FORMAT A20  HEADING "Old Item Title"
            COL new_item_id     FORMAT 9999 HEADING "New|Item|ID #"
            COL new_item_title  FORMAT A30  HEADING "New Item Title"
            SELECT l.logger_id
            ,      l.old_item_id
            ,      l.old_item_title
            ,      l.new_item_id
            ,      l.new_item_title
            FROM   logger l;


            -- Create the ITEM_TRIG trigger and (if needed) ITEM_DELETE_TRIG trigger --
            CREATE OR REPLACE TRIGGER item_trig
              BEFORE INSERT OR UPDATE OR DELETE ON item
              FOR EACH ROW

              DECLARE

                e EXCEPTION;
                PRAGMA EXCEPTION_INIT(e, -20001);

                lv_input_title  VARCHAR2(40);

              BEGIN

                IF INSERTING OR UPDATING THEN

                  IF INSERTING THEN 
                    -- Look for a missing item_id and assign the next SEQUENCE value if empty --
                    IF :NEW.item_id IS NULL THEN 
                      SELECT item_s1.NEXTVAL 
                      INTO   :NEW.item_id 
                      FROM   dual; 
                    END IF;
                    manage_item.item_insert( PV_NEW_ITEM_ID            => :NEW.item_id
                                               , PV_NEW_ITEM_BARCODE       => :NEW.item_barcode
                                               , PV_NEW_ITEM_TYPE          => :NEW.item_type
                                               , PV_NEW_ITEM_TITLE         => :NEW.item_title
                                               , PV_NEW_ITEM_SUBTITLE      => :NEW.item_subtitle
                                               , PV_NEW_ITEM_RATING        => :NEW.item_rating
                                               , PV_NEW_ITEM_RATING_AGENCY => :NEW.item_rating_agency
                                               , PV_NEW_ITEM_RELEASE_DATE  => :NEW.item_release_date
                                               , PV_NEW_CREATED_BY         => :NEW.created_by
                                               , PV_NEW_CREATION_DATE      => :NEW.creation_date
                                               , PV_NEW_LAST_UPDATED_BY    => :NEW.last_updated_by
                                               , PV_NEW_LAST_UPDATE_DATE   => :NEW.last_update_date
                                               , PV_NEW_TEXT_FILE_NAME     => :NEW.text_file_name);

                    lv_input_title := SUBSTR(:NEW.item_title,1,40);

                    -- Check for a subtitle.
                    IF REGEXP_INSTR(lv_input_title,':') > 0 AND
                      REGEXP_INSTR(lv_input_title,':') = LENGTH(lv_input_title) THEN
                    -- Shave off the colon. 
                      :NEW.item_title   := SUBSTR(lv_input_title, 1, REGEXP_INSTR(lv_input_title,':') - 1);
                    ELSIF REGEXP_INSTR(lv_input_title,':') > 0 THEN
                    -- Split the string into two parts. 
                      :NEW.item_title    := SUBSTR(lv_input_title, 1, REGEXP_INSTR(lv_input_title,':') - 1);
                      :NEW.item_subtitle := LTRIM(SUBSTR(lv_input_title,REGEXP_INSTR(lv_input_title,':') + 1, LENGTH(lv_input_title)));
                    END IF;

                  ELSIF UPDATING THEN 
                    manage_item.item_insert( PV_OLD_ITEM_ID            => :old.item_id          
                                           , PV_OLD_ITEM_BARCODE       => :old.item_barcode
                                           , PV_OLD_ITEM_TYPE          => :old.item_type
                                           , PV_OLD_ITEM_TITLE         => :old.item_title
                                           , PV_OLD_ITEM_SUBTITLE      => :old.item_subtitle
                                           , PV_OLD_ITEM_RATING        => :old.item_rating
                                               , PV_OLD_ITEM_RATING_AGENCY => :old.item_rating_agency
                                               , PV_OLD_ITEM_RELEASE_DATE  => :old.item_release_date
                                               , PV_OLD_CREATED_BY         => :old.created_by
                                               , PV_OLD_CREATION_DATE      => :old.creation_date
                                               , PV_OLD_LAST_UPDATED_BY    => :old.last_updated_by
                                               , PV_OLD_LAST_UPDATE_DATE   => :old.last_update_date
                                               , PV_OLD_TEXT_FILE_NAME     => :old.text_file_name
                                               , PV_NEW_ITEM_ID            => :NEW.item_id
                                               , PV_NEW_ITEM_BARCODE       => :NEW.item_barcode 
                                               , PV_NEW_ITEM_TYPE          => :NEW.item_type
                                               , PV_NEW_ITEM_TITLE         => :NEW.item_title
                                               , PV_NEW_ITEM_SUBTITLE      => :NEW.item_subtitle
                                               , PV_NEW_ITEM_RATING        => :NEW.item_rating
                                               , PV_NEW_ITEM_RATING_AGENCY => :NEW.item_rating_agency
                                               , PV_NEW_ITEM_RELEASE_DATE  => :NEW.item_release_date
                                               , PV_NEW_CREATED_BY         => :NEW.created_by
                                               , PV_NEW_CREATION_DATE      => :NEW.creation_date
                                               , PV_NEW_LAST_UPDATED_BY    => :NEW.last_updated_by
                                               , PV_NEW_LAST_UPDATE_DATE   => :NEW.last_update_date
                                               , PV_NEW_TEXT_FILE_NAME     => :NEW.text_file_name);

                    RAISE_APPLICATION_ERROR(-20001, 'No cololons are allowed in titles.');

                  END IF; -- END IF/ELSIF insert/update --

                ELSIF DELETING THEN
                  manage_item.item_insert( PV_OLD_ITEM_ID            => :old.item_id
                                             , PV_OLD_ITEM_BARCODE       => :old.item_barcode
                                             , PV_OLD_ITEM_TYPE          => :old.item_type
                                             , PV_OLD_ITEM_TITLE         => :old.item_title
                                             , PV_OLD_ITEM_SUBTITLE      => :old.item_subtitle
                                             , PV_OLD_ITEM_RATING        => :old.item_rating
                                             , PV_OLD_ITEM_RATING_AGENCY => :old.item_rating_agency
                                             , PV_OLD_ITEM_RELEASE_DATE  => :old.item_release_date
                                             , PV_OLD_CREATED_BY         => :old.created_by
                                             , PV_OLD_CREATION_DATE      => :old.creation_date
                                             , PV_OLD_LAST_UPDATED_BY    => :old.last_updated_by
                                             , PV_OLD_LAST_UPDATE_DATE   => :old.last_update_date
                                             , PV_OLD_TEXT_FILE_NAME     => :old.text_file_name);
                END IF; -- INSERT/DELETE vs DELETE IF --

            END item_trig;
            / 

            -- DROP fk_item_1 --
            ALTER TABLE item DROP CONSTRAINT fk_item_1;
            -- ADD a new fk --
            ALTER TABLE item ADD CONSTRAINT fk_item_1 FOREIGN KEY(item_type) REFERENCES common_lookup(common_lookup_id) ON DELETE CASCADE;
            -- Check it --
            COL item_id        FORMAT 9999 HEADING "Item|ID #"
            COL item_title     FORMAT A20  HEADING "Item Title"
            COL item_subtitle  FORMAT A20  HEADING "Item Subtitle"
            COL item_type      FORMAT 9999 HEADING "Item|Type"
            COL item_rating    FORMAT A6   HEADING "Item|Rating"
            SELECT i.item_id
            ,      i.item_title
            ,      i.item_subtitle
            ,      i.item_type
            ,      i.item_rating
            FROM   item i
            WHERE  i.item_title = 'Star Wars';
              -- SHOULD get no rows selected --

            -- Get rid of the column in the COMMON_LOOKUP table --
            DELETE FROM common_lookup WHERE common_lookup_type = 'BLU-RAY';

            -- Check it --
            COL item_id        FORMAT 9999 HEADING "Item|ID #"
            COL item_title     FORMAT A20  HEADING "Item Title"
            COL item_subtitle  FORMAT A20  HEADING "Item Subtitle"
            COL item_type      FORMAT 9999 HEADING "Item|Type"
            COL item_rating    FORMAT A6   HEADING "Item|Rating"
            SELECT i.item_id
            ,      i.item_title
            ,      i.item_subtitle
            ,      i.item_type
            ,      i.item_rating
            FROM   item i
            WHERE  i.item_title = 'Star Wars';
              -- SHOULD get no rows selected --

            -- Put everything back the way it was --
            ALTER TABLE item DROP CONSTRAINT fk_item_1;
            ALTER TABLE item ADD  CONSTRAINT fk_item_1 FOREIGN KEY(item_type) REFERENCES common_lookup(common_lookup_id);

            INSERT INTO common_lookup
            VALUES
            ( common_lookup_s1.NEXTVAL
            , 'ITEM'
            , 'ITEM_TYPE'
            , 'BLU-RAY'
            , ' '
            , 'Blu-ray'
            , 3, SYSDATE, 3, SYSDATE);

            -- Check it --
            COL common_lookup_table   FORMAT A14 HEADING "Common Lookup|Table"
            COL common_lookup_column  FORMAT A14 HEADING "Common Lookup|Column"
            COL common_lookup_type    FORMAT A14 HEADING "Common Lookup|Type"
            SELECT common_lookup_table
            ,      common_lookup_column
            ,      common_lookup_type
            FROM   common_lookup
            WHERE  common_lookup_table = 'ITEM'
            AND    common_lookup_column = 'ITEM_TYPE'
            AND    common_lookup_type = 'BLU-RAY';
            /* 
            ** SHOULD look something like this ->
            ** ----------------------------------
            ** Common Lookup  Common Lookup Common Lookup
            ** Table          Column        Type
            ** -------------- -------------- --------------
            ** ITEM           ITEM_TYPE      BLU-RAY
            */
            -- Do some inserts to make sure the logger shtuff works --
            INSERT INTO item 
            ( ITEM_ID, ITEM_BARCODE, ITEM_TYPE, ITEM_TITLE, ITEM_SUBTITLE, ITEM_DESC, ITEM_RATING
            , ITEM_RATING_AGENCY, ITEM_RELEASE_DATE, CREATED_BY, CREATION_DATE, LAST_UPDATED_BY, LAST_UPDATE_DATE)
            VALUES 
            ( item_s1.NEXTVAL
            , 'B01IHVPA8'
            , (SELECT common_lookup_id FROM common_lookup WHERE common_lookup_table  = 'ITEM' 
                                                          AND   common_lookup_column = 'ITEM_TYPE'
                                                          AND   common_lookup_type   = 'BLU-RAY')
            , 'Bourne', '', 'DESCRIPTION', 'PG-13', 'MPAA'
            , to_date('2016/12/06', 'YYYY,MM/DD'), 3, SYSDATE, 3, SYSDATE);

            INSERT INTO item 
            ( ITEM_ID, ITEM_BARCODE, ITEM_TYPE, ITEM_TITLE, ITEM_SUBTITLE, ITEM_DESC, ITEM_RATING
            , ITEM_RATING_AGENCY, ITEM_RELEASE_DATE, CREATED_BY, CREATION_DATE, LAST_UPDATED_BY, LAST_UPDATE_DATE)
            VALUES 
            ( item_s1.NEXTVAL
            , 'B01AT251XY'
            , (SELECT common_lookup_id FROM common_lookup WHERE common_lookup_table  = 'ITEM' 
                                                          AND   common_lookup_column = 'ITEM_TYPE'
                                                          AND   common_lookup_type   = 'BLU-RAY')
            , 'Bourne Legacy:', '', 'DESCRIPTION', 'PG-13', 'MPAA'
            , to_date('2016/04/05', 'YYYY,MM/DD'), 3, SYSDATE, 3, SYSDATE);

            INSERT INTO item 
            ( ITEM_ID, ITEM_BARCODE, ITEM_TYPE, ITEM_TITLE, ITEM_SUBTITLE, ITEM_DESC, ITEM_RATING
            , ITEM_RATING_AGENCY, ITEM_RELEASE_DATE, CREATED_BY, CREATION_DATE, LAST_UPDATED_BY, LAST_UPDATE_DATE)
            VALUES 
            ( item_s1.NEXTVAL
            , 'B018FK66TU'
            , (SELECT common_lookup_id FROM common_lookup WHERE common_lookup_table  = 'ITEM' 
                                                          AND   common_lookup_column = 'ITEM_TYPE'
                                                          AND   common_lookup_type   = 'BLU-RAY')
            , 'Star Wars: The Force Awakens', '', 'DESCRIPTION', 'PG-13', 'MPAA'
            , to_date('2016/04/05', 'YYYY,MM/DD'), 3, SYSDATE, 3, SYSDATE);

            COL item_id        FORMAT 9999 HEADING "Item|ID #"
            COL item_title     FORMAT A20  HEADING "Item Title"
            COL item_subtitle  FORMAT A20  HEADING "Item Subtitle"
            COL item_rating    FORMAT A6   HEADING "Item|Rating"
            COL item_type      FORMAT A18   HEADING "Item|Type"
            SELECT i.item_id
            ,      i.item_title
            ,      i.item_subtitle
            ,      i.item_rating
            ,      cl.common_lookup_meaning AS item_type
            FROM   item i INNER JOIN common_lookup cl
            ON     i.item_type = cl.common_lookup_id
            WHERE  cl.common_lookup_type = 'BLU-RAY';
            /* 
            ** SHOULD look like this: 
            **  Item						                               Item   Item
            **  ID # Item Title	          Item Subtitle	       Rating Type
            ** ----- -------------------- -------------------- ------ ------------------
            **  1094 Bourne					                           PG-13  Blu-ray
            **  1095 Bourne Legacy				                     PG-13  Blu-ray
            **  1096 Star Wars 	          The Force Awakens	   PG-13  Blu-ray
            */

            /* Query the logger table. */
            COL logger_id       FORMAT 9999 HEADING "Logger|ID #"
            COL old_item_id     FORMAT 9999 HEADING "Old|Item|ID #"
            COL old_item_title  FORMAT A20  HEADING "Old Item Title"
            COL new_item_id     FORMAT 9999 HEADING "New|Item|ID #"
            COL new_item_title  FORMAT A30  HEADING "New Item Title"
            SELECT l.logger_id
            ,      l.old_item_id
            ,      l.old_item_title
            ,      l.new_item_id
            ,      l.new_item_title
            FROM   logger l;
            /* 
            ** SHOULD look like this
            **        Old			                    New
            ** Logger	Item			                  Item
            **   ID #	ID #  Old Item Title	      ID # New Item Title
            ** ------ ----- -------------------- ----- ------------------------------
            **      1	1014 Brave Heart	          1014 Brave Heart
            **      2				                      1035 King Arthur
            **      3	1035 King Arthur	          1035 King Arthur-Changed
            **      4	1035 King Arthur-Deleted
            **      5				                      1095 Bourne Legacy:
            **      6				                      1096 Star Wars: The Force Awakens
            **      7	1096 Star Wars		          1096 Star Wars: The Force Awakens
            */

            UPDATE item SET item_title = 'Star Wars: The Force Awakens' WHERE item_barcode = 'B018FK66TU';
            /* 
            ** SHOULD get an error similar to this **
            UPDATE item
                   *
            ERROR at line 1:
            ORA-20001: No colons allowed in item titles.
            ORA-06512: at "STUDENT.ITEM_TRIG", line 75
            ORA-04088: error during execution of trigger 'STUDENT.ITEM_TRIG'
            */

            COL item_id        FORMAT 9999 HEADING "Item|ID #"
            COL item_title     FORMAT A20  HEADING "Item Title"
            COL item_subtitle  FORMAT A20  HEADING "Item Subtitle"
            COL item_rating    FORMAT A6   HEADING "Item|Rating"
            COL item_type      FORMAT A18   HEADING "Item|Type"
            SELECT i.item_id
            ,      i.item_title
            ,      i.item_subtitle
            ,      i.item_rating
            ,      cl.common_lookup_meaning AS item_type
            FROM   item i INNER JOIN common_lookup cl
            ON     i.item_type = cl.common_lookup_id
            WHERE  cl.common_lookup_type = 'BLU-RAY';
            /* 
            **  Item						                               Item   Item
            **  ID # Item Title	          Item Subtitle	       Rating Type
            ** ----- -------------------- -------------------- ------ ------------------
            **  1094 Bourne					                            PG-13  Blu-ray
            **  1095 Bourne Legacy				                      PG-13  Blu-ray
            **  1096 Star Wars 	          The Force Awakens	    PG-13  Blu-ray
            */

            COL logger_id       FORMAT 9999 HEADING "Logger|ID #"
            COL old_item_id     FORMAT 9999 HEADING "Old|Item|ID #"
            COL old_item_title  FORMAT A20  HEADING "Old Item Title"
            COL new_item_id     FORMAT 9999 HEADING "New|Item|ID #"
            COL new_item_title  FORMAT A30  HEADING "New Item Title"
            SELECT l.logger_id
            ,      l.old_item_id
            ,      l.old_item_title
            ,      l.new_item_id
            ,      l.new_item_title
            FROM   logger l;
            /* 
            ** 	      Old			                   New
            ** Logger	Item			                 Item
            **   ID #	ID #  Old Item Title	     ID #  New Item Title
            ** ------ ----- -------------------- ----- ------------------------------
            **      1	1014 Brave Heart	         1014  Brave Heart
            **      2				                     1035  King Arthur
            **      3	1035 King Arthur	         1035  King Arthur-Changed
            **      4	1035 King Arthur-Deleted
            **      5				                     1095  Bourne Legacy:
            **      6				                     1096  Star Wars: The Force Awakens
            **      7	1096 Star Wars		         1096  Star Wars: The Force Awakens
            */

            -- DELETE STAR WARS --
            DELETE FROM item WHERE item_id = 1096;

            COL item_id        FORMAT 9999 HEADING "Item|ID #"
            COL item_title     FORMAT A20  HEADING "Item Title"
            COL item_subtitle  FORMAT A20  HEADING "Item Subtitle"
            COL item_rating    FORMAT A6   HEADING "Item|Rating"
            COL item_type      FORMAT A18   HEADING "Item|Type"
            SELECT i.item_id
            ,      i.item_title
            ,      i.item_subtitle
            ,      i.item_rating
            ,      cl.common_lookup_meaning AS item_type
            FROM   item i INNER JOIN common_lookup cl
            ON     i.item_type = cl.common_lookup_id
            WHERE  cl.common_lookup_type = 'BLU-RAY';
            /* 
            **  Item						                               Item   Item
            **  ID # Item Title	          Item Subtitle	       Rating Type
            ** ----- -------------------- -------------------- ------ ------------------
            **  1094 Bourne					                           PG-13  Blu-ray
            **  1095 Bourne Legacy				                     PG-13  Blu-ray
            */

            COL logger_id       FORMAT 9999 HEADING "Logger|ID #"
            COL old_item_id     FORMAT 9999 HEADING "Old|Item|ID #"
            COL old_item_title  FORMAT A20  HEADING "Old Item Title"
            COL new_item_id     FORMAT 9999 HEADING "New|Item|ID #"
            COL new_item_title  FORMAT A30  HEADING "New Item Title"
            SELECT l.logger_id
            ,      l.old_item_id
            ,      l.old_item_title
            ,      l.new_item_id
            ,      l.new_item_title
            FROM   logger l; 
            /* 
            ** 	      Old			                   New
            ** Logger	Item			                 Item
            **   ID #	ID #  Old Item Title	     ID #  New Item Title
            ** ------ ----- -------------------- ----- ------------------------------
            **      1	1014 Brave Heart	         1014  Brave Heart
            **      2				                     1035  King Arthur
            **      3	1035 King Arthur	         1035  King Arthur-Changed
            **      4	1035 King Arthur-Deleted
            **      5				                     1095  Bourne Legacy:
            **      6				                     1096  Star Wars: The Force Awakens
            **      7	1096 Star Wars		         1096  Star Wars: The Force Awakens
            **      8	1096 Star Wars
            */ 

            SPOOL OFF

            EXIT
            </code></pre></p>            
        </main>
        <footer>
            <h2>Work done by Bill Enkey in a database course provided at Brigham Young University, Idaho</h2>
            <h2>NOT intended to be used or copied.</h2>
        </footer>
    </body>
</html>